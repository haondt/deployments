components:
  primary:
    image: docker.io/linuxserver/radarr:latest@sha256:c984533510abe0219a70e80d15bd0d212b7df21baa0913759c4ce6cc9092240b
    talos: +!
    resources:
      requests.memory: 256Mi
      limits.memory: 2Gi
    networking:
      ports:
        http: 7878
      ingresses:
        - port: http
          host: "radarr.{{ haondt__default_host }}"
          tls.host: "*.{{ haondt__default_host }}"
          nginx.proxy_body_size: 128m
      dependencies:
        - name: primary
          app: qbittorrent
          port: http
        - name: primary
          app: prowlarr
          port: http
    observability: &observability
      alloy.logs.process: |
        stage.regex {
          expression = "^\\[(?P<level>\\w+)\\]"
        }
        stage.template {
          source = "level"
          template = "{{ or .Value \"Info\"}}"
        }
        stage.labels {
          values = { "level" = "" }
        }
      probes.hc:
        http_get:
          port: http
          path: /ping
        alloy.blackbox: {}
    volumes:
      config:
        src.pvc: {}
        dest.dir: /config
      carrot-movies:
        src.host:
          dir: "{{ media__host_dirs__carrot }}/movies"
          read_only: false
        dest.dir: /mnt/carrot/movies
      rhyolite-movies:
        src.host:
          dir: "{{ media__host_dirs__rhyolite }}/movies"
          read_only: false
        dest.dir: /mnt/rhyolite/movies
      downloads:
        src.host.dir: "{{ media__host_dirs__downloads }}"
        dest.dir: /downloads
    startup:
      tasks:
        - chown:
            paths: [/config]
            owner: "{{ media__puid }}:{{ media__pgid }}"
        - busybox:
            script: |-
              set -euo pipefail
              CONFIG="/config/config.xml"

              if [[ -f "$CONFIG" ]] && grep -q "<AuthenticationMethod>.*</AuthenticationMethod>" "$CONFIG"; then
                  if ! grep -q "<AuthenticationMethod>External</AuthenticationMethod>" "$CONFIG"; then
                      sed -i -E 's|<AuthenticationMethod>.*</AuthenticationMethod>|<AuthenticationMethod>External</AuthenticationMethod>|' "$CONFIG"
                  fi
              fi
    environment:
      - raw:
          PGID: "{{ media__pgid }}"
          PUID: "{{ media__puid }}"
  hd:
    image: docker.io/linuxserver/radarr:latest@sha256:e26fbfd3782520c0bb820666f041ca056acfe187a8b95214ee1f47512cc05a29
    talos: +!
    resources:
      limits.memory: 2Gi
      requests.memory: 256Mi
    networking:
      ports:
        http: 7878
      ingresses:
        - port: http
          host: "radarr-hd.{{ haondt__default_host }}"
          tls.host: "*.{{ haondt__default_host }}"
          nginx.proxy_body_size: 128m
      dependencies:
        - name: primary
          app: qbittorrent
          port: http
        - name: primary
          app: prowlarr
          port: http
    observability:
      <<: *observability
      probes.hc.alloy.blackbox.labels.dev_haondt_app: radarr-hd
    volumes:
      config-hd:
        src.pvc: {}
        dest.dir: /config
      carrot-movies-hd:
        src.host:
          dir: "{{ media__host_dirs__carrot }}/movies_hd"
          read_only: false
        dest.dir: /mnt/carrot/movies
      rhyolite-movies-hd:
        src.host:
          dir: "{{ media__host_dirs__rhyolite }}/movies_hd"
          read_only: false
        dest.dir: /mnt/rhyolite/movies
      downloads-hd:
        src.host.dir: "{{ media__host_dirs__downloads }}"
        dest.dir: /downloads
    startup:
      tasks:
        - chown:
            paths: [/config]
            owner: "{{ media__puid }}:{{ media__pgid }}"
        - busybox:
            script: |-
              set -euo pipefail
              CONFIG="/config/config.xml"

              if [[ -f "$CONFIG" ]] && grep -q "<AuthenticationMethod>.*</AuthenticationMethod>" "$CONFIG"; then
                  if ! grep -q "<AuthenticationMethod>External</AuthenticationMethod>" "$CONFIG"; then
                      sed -i -E 's|<AuthenticationMethod>.*</AuthenticationMethod>|<AuthenticationMethod>External</AuthenticationMethod>|' "$CONFIG"
                  fi
              fi
    environment:
      - raw:
          PGID: "{{ media__pgid }}"
          PUID: "{{ media__puid }}"
