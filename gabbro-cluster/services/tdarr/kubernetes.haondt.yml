components:
  primary:
    image: ghcr.io/haveagitgat/tdarr:latest
    # talos: +!
    resources:
      limits:
        memory: 2Gi
      gpu.enabled: true
    networking:
      ports:
        http: 8265
        server: 8266
      ingresses:
        - port: http
          host: "fileflows.{{ haondt__default_host }}"
    volumes:
      server:
        src.host:
          dir: "/mnt/pepper/gabbro_cluster/tdarr/server"
          read_only: false
          create: true
        dest.dir: /app/server
      configs:
        src.host:
          dir: "/mnt/pepper/gabbro_cluster/tdarr/configs"
          read_only: false
          create: true
        dest.dir: /configs
      temp:
        src.host:
          dir: "/mnt/pepper/gabbro_cluster/tdarr/temp"
          read_only: false
          create: true
        dest.dir: /temp
      celery-tv-shows:
        src.host.dir: "{{ media__host_dirs__celery }}/tv_shows"
        src.host.read_only: false
        dest.dir: /mnt/celery/tv_shows
      celery-movies:
        src.host.dir: "{{ media__host_dirs__celery }}/movies"
        src.host.read_only: false
        dest.dir: /mnt/celery/movies
      celery-movies-hd:
        src.host.dir: "{{ media__host_dirs__celery }}/movies_hd"
        src.host.read_only: false
        dest.dir: /mnt/celery/movies_hd
      rhyolite-tv-shows:
        src.host.dir: "{{ media__host_dirs__rhyolite }}/tv_shows"
        src.host.read_only: false
        dest.dir: /mnt/rhyolite/tv_shows
      rhyolite-movies:
        src.host.dir: "{{ media__host_dirs__rhyolite }}/movies"
        src.host.read_only: false
        dest.dir: /mnt/rhyolite/movies
      rhyolite-movies-hd:
        src.host.dir: "{{ media__host_dirs__rhyolite }}/movies_hd"
        src.host.read_only: false
        dest.dir: /mnt/rhyolite/movies_hd
    startup:
      tasks:
        - chown:
            paths: [/app/server,/app/configs,/temp]
            owner: "{{ media__puid }}:{{ media__pgid }}"
    environment:
      - raw:
          PGID: "{{ media__pgid }}"
          PUID: "{{ media__puid }}"
          NVIDIA_VISIBLE_DEVICES: all
          NVIDIA_DRIVER_CAPABILITIES: compute,video,utility
          UMASK_SET: "002"
          serverIP: "0.0.0.0"
          serverPort: "8266"
          webUIPort: "8265"
          internalNode: "true"
          inContainer: "true"
          ffmpegVersion: "7"
          nodeName: "gabbro-tdarr-01"
          auth: "false"
          openBrowser: "true"
          maxLogSizeMB: "10"
          cronPluginUpdate: ""
