components:
  primary:
    image: docker.io/jasongdove/ersatztv:latest@sha256:e9bca2252705250356d76eafb5f2f02ea96d18fbf38613a1389279966811d5e0
    talos: +!
    resources:
      requests:
        memory: 1Gi
      limits:
        memory: 4Gi
      gpu.enabled: true
    networking:
      ports:
        http: 8409
      ingresses:
        - port: http
          host: "ersatztv.{{ haondt__default_host }}"
          tls.host: "*.{{ haondt__default_host }}"
    volumes:
      config:
        src.host:
          dir: "/mnt/celery/gabbro_cluster/ersatztv/config"
          read_only: false
        dest.dir: /root/.local/share/ersatztv
      transcode:
        src.host:
          dir: "/mnt/pepper/gabbro_cluster/ersatztv/transcode"
          read_only: false
          create: true
        dest.dir: /root/.local/share/etv-transcode
      celery-tv-shows:
        src.host.dir: "{{ media__host_dirs__celery }}/tv_shows"
        dest.dir: /mnt/celery/tv_shows
      celery-movies:
        src.host.dir: "{{ media__host_dirs__celery }}/movies"
        dest.dir: /mnt/celery/movies
      celery-movies-hd:
        src.host.dir: "{{ media__host_dirs__celery }}/movies_hd"
        dest.dir: /mnt/celery/movies_hd
      rhyolite-tv-shows:
        src.host.dir: "{{ media__host_dirs__rhyolite }}/tv_shows"
        dest.dir: /mnt/rhyolite/tv_shows
      rhyolite-movies:
        src.host.dir: "{{ media__host_dirs__rhyolite }}/movies"
        dest.dir: /mnt/rhyolite/movies
      rhyolite-movies-hd:
        src.host.dir: "{{ media__host_dirs__rhyolite }}/movies_hd"
        dest.dir: /mnt/rhyolite/movies_hd
    startup:
      tasks:
        - chmod:
            paths:
              - /root/.local/share/ersatztv
              - /root/.local/share/etv-transcode
            mode: '777'
    environment:
      - raw:
          NVIDIA_VISIBLE_DEVICES: all
          NVIDIA_DRIVER_CAPABILITIES: compute,video,utility
