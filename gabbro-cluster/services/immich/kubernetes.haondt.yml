components:
  server:
    image: ghcr.io/immich-app/immich-server:v2.5.0@sha256:6c011eaa315b871f3207d68f97205d92b3e600104466a75b01eb2c3868e72ca1
    talos:
      skip: false
      bump: Major
      strategy:
        digest: Skip
        patch: Push
        minor: Push
        major: Prompt
      sync:
        role: parent
        group: immich
        id: server
        children: [ml]
        digest: false
    resources:
      limits:
        memory: 2Gi
    networking:
      ports:
        http: 2283
      dependencies:
        - name: db
          port: http
        - name: redis
          port: http
        - name: machine-learning
          port: http
      rathole_routes:
        - port: http
          host: "immich.{{ haondt__default_cloud_host }}"
          max_body_size:  50000m
    observability:
      probes.hc:
        http_get:
          port: http
          path: /api/server/ping
        alloy.blackbox: {}
    volumes:
      upload:
        src.host:
          dir: "/mnt/carrot/gabbro/immich/upload"
          read_only: false
        dest.dir: /data
    charon:
      overlays: [daily]
      backups:
        - overlays: [default-hzsb]
          repository_configs:
            - raw: |-
                backend:
                  path: deployments-immich-server
          source.volumes:
            upload: [/]
    environment:
      - raw:
          DB_PASSWORD: "{{ immich__postgres_password }}"
          secret: true
      - raw:
          DB_USERNAME: postgres
          DB_DATABASE_NAME: immich
          DB_HOSTNAME: immich-db
          DB_PORT: 5432
          REDIS_HOSTNAME: immich-redis
          REDIS_PORT: 6379

  machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:v2.5.0@sha256:5fee7f3e052c3d32d4edecafad68317394daae26f57d895fbd487886083725a7
    talos:
      skip: false
      sync:
        role: child
        group: immich
        id: ml
    resources:
      requests:
        memory: 256Mi
      limits:
        memory: 2Gi
    networking:
      ports:
        http: 3003
      dependencies:
        - name: db
          port: http
        - name: redis
          port: http
    volumes:
      model-cache:
        src.pvc: {}
        dest.dir: /cache
    environment:
      - raw:
          DB_PASSWORD: "{{ immich__postgres_password }}"
          secret: true
      - raw:
          DB_USERNAME: postgres
          DB_DATABASE_NAME: immich
          DB_HOSTNAME: immich-db
          DB_PORT: 5432
          REDIS_HOSTNAME: immich-redis
          REDIS_PORT: 6379

  redis:
    image: docker.io/valkey/valkey:9@sha256:546304417feac0874c3dd576e0952c6bb8f06bb4093ea0c9ca303c73cf458f63
    talos: ^!
    networking:
      ports:
        http: 6379
    volumes:
      redis-data:
        src.pvc: {}
        dest.dir: /data
    startup:
      tasks:
        - chmod:
            paths: [/data]
            mode: '0777'

  db:
    image: ghcr.io/immich-app/postgres:14-vectorchord0.4.3-pgvectors0.2.0@sha256:bcf63357191b76a916ae5eb93464d65c07511da41e3bf7a8416db519b40b1c23
    talos: x
    resources:
      limits.memory: 1Gi
    networking:
      ports:
        http: 5432
    environment:
      - raw:
          POSTGRES_PASSWORD: "{{ immich__postgres_password }}"
        secret: true
      - raw:
          POSTGRES_USER: postgres
          POSTGRES_DB: immich
          POSTGRES_INITDB_ARGS: '--data-checksums'
          DB_STORAGE_TYPE: HDD
    volumes:
      db-data:
        src.host:
          dir: /mnt/pepper/gabbro_cluster/immich/db
          read_only: false
        dest.dir: /var/lib/postgresql/data

