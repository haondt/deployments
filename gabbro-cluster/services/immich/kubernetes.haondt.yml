components:
  server:
    image: ghcr.io/immich-app/immich-server:v2.2.2@sha256:6f57cf359f57f05c89238680b39ca7cd0e135477e11247ad4beb02cc740bbfda
    talos:
      skip: false
      bump: Major
      strategy:
        digest: Skip
        patch: Push
        minor: Push
        major: Prompt
      sync:
        role: parent
        group: immich
        id: server
        children: [ml]
        digest: false
    resources:
      limits:
        memory: 2Gi
    networking:
      ports:
        http: 2283
      dependencies:
        - name: db
          port: http
        - name: redis
          port: http
        - name: machine-learning
          port: http
      rathole_routes:
        - port: http
          host: "immich.{{ haondt__default_cloud_host }}"
          max_body_size:  50000m
    observability:
      probes.hc:
        http_get:
          port: http
          path: /api/server/ping
        alloy.blackbox: {}
    volumes:
      upload:
        src.host:
          dir: "/mnt/celery/gabbro/immich/upload"
          read_only: false
        dest.dir: /data
    charon:
      - overlays: [default-hzsb, daily]
        repository_configs:
          - raw: |-
              backend:
                path: deployments-immich-server
        source.volumes:
          upload: [/]
    environment:
      - raw:
          DB_PASSWORD: "{{ immich__postgres_password }}"
          secret: true
      - raw:
          DB_USERNAME: postgres
          DB_DATABASE_NAME: immich
          DB_HOSTNAME: immich-db-http
          DB_PORT: 8080
          REDIS_HOSTNAME: immich-redis-http
          REDIS_PORT: 8080

  machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:v2.2.2@sha256:848b097e1250695ceaa371824b441356847140328bcfb921bdd5e3459878d535
    talos:
      skip: false
      sync:
        role: child
        group: immich
        id: ml
    resources:
      requests:
        memory: 256Mi
      limits:
        memory: 2Gi
    networking:
      ports:
        http: 3003
      dependencies:
        - name: db
          port: http
        - name: redis
          port: http
    volumes:
      model-cache:
        src.pvc: {}
        dest.dir: /cache
    environment:
      - raw:
          DB_PASSWORD: "{{ immich__postgres_password }}"
          secret: true
      - raw:
          DB_USERNAME: postgres
          DB_DATABASE_NAME: immich
          DB_HOSTNAME: immich-db-http
          DB_PORT: 8080
          REDIS_HOSTNAME: immich-redis-http
          REDIS_PORT: 8080

  redis:
    image: docker.io/redis:6.2-alpine@sha256:77697a75da9f94e9357b61fcaf8345f69e3d9d32e9d15032c8415c21263977dc
    talos: ^!
    networking:
      ports:
        http: 6379
    volumes:
      redis-data:
        src.pvc: {}
        dest.dir: /data
    startup:
      tasks:
        - chmod:
            paths: [/data]
            mode: '0777'

  db:
    image: ghcr.io/immich-app/postgres:14-vectorchord0.3.0-pgvectors0.2.0
    talos: x
    resources:
      limits.memory: 1Gi
    networking:
      ports:
        http: 5432
    environment:
      - raw:
          POSTGRES_PASSWORD: "{{ immich__postgres_password }}"
        secret: true
      - raw:
          POSTGRES_USER: postgres
          POSTGRES_DB: immich
          POSTGRES_INITDB_ARGS: '--data-checksums'
          DB_STORAGE_TYPE: HDD
    volumes:
      db-data:
        src.host:
          dir: /mnt/celery/gabbro/immich/db
          read_only: false
        dest.dir: /var/lib/postgresql/data

