components:
  server:
    image: ghcr.io/immich-app/immich-server:v2.4.1@sha256:e6a6298e67ae077808fdb7d8d5565955f60b0708191576143fc02d30ab1389d1
    talos:
      skip: false
      bump: Major
      strategy:
        digest: Skip
        patch: Push
        minor: Push
        major: Prompt
      sync:
        role: parent
        group: immich
        id: server
        children: [ml]
        digest: false
    resources:
      limits:
        memory: 2Gi
    networking:
      ports:
        http: 2283
      dependencies:
        - name: db
          port: http
        - name: redis
          port: http
        - name: machine-learning
          port: http
      rathole_routes:
        - port: http
          host: "immich.{{ haondt__default_cloud_host }}"
          max_body_size:  50000m
    observability:
      probes.hc:
        http_get:
          port: http
          path: /api/server/ping
        alloy.blackbox: {}
    volumes:
      upload:
        src.host:
          dir: "/mnt/carrot/gabbro/immich/upload"
          read_only: false
        dest.dir: /data
    charon:
      overlays: [daily]
      backups:
        - overlays: [default-hzsb]
          repository_configs:
            - raw: |-
                backend:
                  path: deployments-immich-server
          source.volumes:
            upload: [/]
    environment:
      - raw:
          DB_PASSWORD: "{{ immich__postgres_password }}"
          secret: true
      - raw:
          DB_USERNAME: postgres
          DB_DATABASE_NAME: immich
          DB_HOSTNAME: immich-db-http
          DB_PORT: 8080
          REDIS_HOSTNAME: immich-redis-http
          REDIS_PORT: 8080

  machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:v2.4.1@sha256:b3deefd1826f113824e9d7bc30d905e7f823535887d03f869330946b6db3b44a
    talos:
      skip: false
      sync:
        role: child
        group: immich
        id: ml
    resources:
      requests:
        memory: 256Mi
      limits:
        memory: 2Gi
    networking:
      ports:
        http: 3003
      dependencies:
        - name: db
          port: http
        - name: redis
          port: http
    volumes:
      model-cache:
        src.pvc: {}
        dest.dir: /cache
    environment:
      - raw:
          DB_PASSWORD: "{{ immich__postgres_password }}"
          secret: true
      - raw:
          DB_USERNAME: postgres
          DB_DATABASE_NAME: immich
          DB_HOSTNAME: immich-db-http
          DB_PORT: 8080
          REDIS_HOSTNAME: immich-redis-http
          REDIS_PORT: 8080

  redis:
    image: docker.io/redis:6.2-alpine@sha256:37e002448575b32a599109664107e374c8709546905c372a34d64919043b9ceb
    talos: ^!
    networking:
      ports:
        http: 6379
    volumes:
      redis-data:
        src.pvc: {}
        dest.dir: /data
    startup:
      tasks:
        - chmod:
            paths: [/data]
            mode: '0777'

  db:
    image: ghcr.io/immich-app/postgres:14-vectorchord0.3.0-pgvectors0.2.0
    talos: x
    resources:
      limits.memory: 1Gi
    networking:
      ports:
        http: 5432
    environment:
      - raw:
          POSTGRES_PASSWORD: "{{ immich__postgres_password }}"
        secret: true
      - raw:
          POSTGRES_USER: postgres
          POSTGRES_DB: immich
          POSTGRES_INITDB_ARGS: '--data-checksums'
          DB_STORAGE_TYPE: HDD
    volumes:
      db-data:
        src.host:
          dir: /mnt/pepper/gabbro_cluster/immich/db
          read_only: false
        dest.dir: /var/lib/postgresql/data

