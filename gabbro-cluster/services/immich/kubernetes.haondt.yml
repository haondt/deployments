components:
  server:
    image: &immich_image ghcr.io/immich-app/immich-server:v2.1.0@sha256:72a9b9de6c6abfa7a9c9cdc244ae4d2bd9fea2ae00997f194cbd10aca72ea210
    talos:
      skip: false
      bump: Major
      strategy:
        digest: Skip
        patch: Push
        minor: Push
        major: Prompt
    resources:
      limits:
        memory: 1Gi
    networking:
      ports:
        http: 2283
      dependencies:
        - name: db
          port: http
        - name: redis
          port: http
        - name: machine-learning
          port: http
      rathole_routes:
        - port: http
          host: "immich.{{ haondt__default_cloud_host }}"
          max_body_size:  50000m
    volumes:
      upload:
        src.host:
          dir: "/mnt/celery/gabbro/immich/upload"
          read_only: false
        dest.dir: /data
    environment:
      - raw:
          DB_PASSWORD: "{{ immich__postgres_password }}"
          secret: true
      - raw:
          DB_USERNAME: postgres
          DB_DATABASE_NAME: immich
          DB_HOSTNAME: immich-db-http
          DB_PORT: 8080
          REDIS_HOSTNAME: immich-redis-http
          REDIS_PORT: 8080

  machine-learning:
    image: *immich_image
    talos: x
    resources:
      requests:
        memory: 256Mi
      limits:
        memory: 2Gi
    networking:
      ports:
        http: 3003
      dependencies:
        - name: db
          port: http
        - name: redis
          port: http
    volumes:
      model-cache:
        src.pvc: {}
        dest.dir: /cache
      ml-data:
        src.host:
          dir: "/mnt/celery/gabbro/immich/machine-learning-data"
          read_only: false
          create: true
        dest.dir: /data
    environment:
      - raw:
          DB_PASSWORD: "{{ immich__postgres_password }}"
          secret: true
      - raw:
          DB_USERNAME: postgres
          DB_DATABASE_NAME: immich
          DB_HOSTNAME: immich-db-http
          DB_PORT: 8080
          REDIS_HOSTNAME: immich-redis-http
          REDIS_PORT: 8080

  redis:
    image: docker.io/redis:6.2-alpine@sha256:77697a75da9f94e9357b61fcaf8345f69e3d9d32e9d15032c8415c21263977dc
    x-tl: ^!
    networking:
      ports:
        http: 6379
    volumes:
      redis-data:
        src.pvc: {}
        dest.dir: /data
    startup:
      tasks:
        - chmod:
            paths: [/data]
            mode: '0777'

  db:
    image: ghcr.io/immich-app/postgres:14-vectorchord0.3.0-pgvectors0.2.0
    talos: "@!"
    networking:
      ports:
        http: 5432
    environment:
      - raw:
          POSTGRES_PASSWORD: "{{ immich__postgres_password }}"
        secret: true
      - raw:
          POSTGRES_USER: postgres
          POSTGRES_DB: immich
          POSTGRES_INITDB_ARGS: '--data-checksums'
          DB_STORAGE_TYPE: HDD
    volumes:
      db-data:
        src.host:
          dir: /mnt/celery/gabbro/immich/db
          read_only: false
        dest.dir: /var/lib/postgresql/data
