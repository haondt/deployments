components:
  primary:
    image: ghcr.io/paperless-ngx/paperless-ngx:latest@sha256:7b937cb2fa2885ab0ecfceb8c7e8827e2312472d9d897a270097ba7f5522dcdc
    talos: +!
    networking:
      ports:
        http: 8000
      gateway.http_routes:
        - port: http
          host: "paperless.{{ haondt__default_host }}"
      dependencies:
        - name: db
          port: http
        - name: broker
          port: http
    resources.limits.memory: 1Gi
    volumes:
      data:
        src.host:
          dir: /mnt/pepper/gabbro_cluster/paperless/data
          read_only: false
        dest.dir: /usr/src/paperless/data
      media:
        src.host:
          dir: /mnt/carrot/gabbro/paperless/media
          read_only: false
        dest.dir: /usr/src/paperless/media
      export:
        src.host:
          dir: /mnt/carrot/gabbro/paperless/export
          read_only: false
        dest.dir: /usr/src/paperless/export
      consume:
        src.host:
          dir: /mnt/carrot/gabbro/paperless/consume
          read_only: false
        dest.dir: /usr/src/paperless/consume
    environment:
      - raw:
          PAPERLESS_REDIS: redis://paperless-broker:6379
          PAPERLESS_DBENGINE: mariadb
          PAPERLESS_DBHOST: paperless-db
          PAPERLESS_DBUSER: paperless # only needed if non-default username
          PAPERLESS_DBPASS: paperless # only needed if non-default password
          PAPERLESS_DBPORT: 3306
          PAPERLESS_URL: https://paperless.{{ haondt__default_host }}
          PAPERLESS_TIME_ZONE: America/Edmonton

          PAPERLESS_ADMIN_USER: "{{ paperless__admin_user }}"
          PAPERLESS_ADMIN_PASSWORD: "{{ paperless__admin_password }}"


  db:
    image: docker.io/library/mariadb:10@sha256:21d87f60a6d84d25871738c64e468ea56118d73e90f614fbde09695ca9879c6e
    talos: ^!
    networking:
      ports:
        http: 3306
    volumes:
      db-data:
        src.host:
          dir: /mnt/pepper/gabbro_cluster/paperless/db
          read_only: false
        dest.dir: /var/lib/mysql
    environment:
      - raw:
          MARIADB_HOST: paperless
          MARIADB_DATABASE: paperless
          MARIADB_USER: paperless
          MARIADB_PASSWORD: paperless
          MARIADB_ROOT_PASSWORD: paperless
  broker:
    image: docker.io/library/redis:7@sha256:976ab0f0939b78c06d802bcd3bea44c5142ea9a756a57b861e08819817f768c8
    talos: ^!
    networking:
      ports:
        http: 6379
    volumes:
      broker-data:
        src.host:
          dir: /mnt/pepper/gabbro_cluster/paperless/redis
          read_only: false
        dest.dir: /data
