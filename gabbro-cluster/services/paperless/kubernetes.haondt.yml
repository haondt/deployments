components:
  primary:
    image: ghcr.io/paperless-ngx/paperless-ngx:latest@sha256:8ffd737c69a569bbdadc118e7f54b0b1050ffac2868fdf9e390a68cb7c82a79d
    talos: +!
    networking:
      ports:
        http: 8000
      ingresses:
        - port: http
          host: "paperless.{{ haondt__default_host }}"
          tls.host: "*.{{ haondt__default_host }}"
      dependencies:
        - name: db
          port: http
        - name: broker
          port: http
    resources.limits.memory: 1Gi
    volumes:
      data:
        src.host:
          dir: /mnt/pepper/gabbro_cluster/paperless/data
          read_only: false
        dest.dir: /usr/src/paperless/data
      media:
        src.host:
          dir: /mnt/carrot/gabbro/paperless/media
          read_only: false
        dest.dir: /usr/src/paperless/media
      export:
        src.host:
          dir: /mnt/carrot/gabbro/paperless/export
          read_only: false
        dest.dir: /usr/src/paperless/export
      consume:
        src.host:
          dir: /mnt/carrot/gabbro/paperless/consume
          read_only: false
        dest.dir: /usr/src/paperless/consume
    environment:
      - raw:
          PAPERLESS_REDIS: redis://paperless-broker-http:8080
          PAPERLESS_DBENGINE: mariadb
          PAPERLESS_DBHOST: paperless-db-http
          PAPERLESS_DBUSER: paperless # only needed if non-default username
          PAPERLESS_DBPASS: paperless # only needed if non-default password
          PAPERLESS_DBPORT: 8080
          PAPERLESS_URL: https://paperless.{{ haondt__default_host }}
          PAPERLESS_TIME_ZONE: America/Edmonton

          PAPERLESS_ADMIN_USER: "{{ paperless__admin_user }}"
          PAPERLESS_ADMIN_PASSWORD: "{{ paperless__admin_password }}"


  db:
    image: docker.io/library/mariadb:10@sha256:8763a63f00ec980d913c04bf84f7fd5f60aa11ac9033f36d1a77921c065a5988
    talos: ^!
    networking:
      ports:
        http: 3306
    volumes:
      db-data:
        src.host:
          dir: /mnt/pepper/gabbro_cluster/paperless/db
          read_only: false
        dest.dir: /var/lib/mysql
    environment:
      - raw:
          MARIADB_HOST: paperless
          MARIADB_DATABASE: paperless
          MARIADB_USER: paperless
          MARIADB_PASSWORD: paperless
          MARIADB_ROOT_PASSWORD: paperless
  broker:
    image: docker.io/library/redis:7@sha256:483eaf69e400c5254a2dae9c9f9499c336ecc0537c36fca462516a8f8bf75f78
    talos: ^!
    networking:
      ports:
        http: 6379
    volumes:
      broker-data:
        src.host:
          dir: /mnt/pepper/gabbro_cluster/paperless/redis
          read_only: false
        dest.dir: /data
