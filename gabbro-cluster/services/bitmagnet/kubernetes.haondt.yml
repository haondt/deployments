components:
  primary:
    image: ghcr.io/bitmagnet-io/bitmagnet:v0.10.0@sha256:cf2c16fac5b51f1c18e630b4710175d35d7e44b83012cfd05a2b43712feec05e
    talos: +!
    resources:
      requests.memory: 512Mi
      limits.memory: 2Gi
    observability:
      probes.hc:
        http_get:
          port: http
          path: /status
        alloy.blackbox: {}
    networking:
      ports:
        http: 3333
        bt1: 3334
        bt2:
          port: 3334
          protocol: udp
      gateway.http_routes:
        - port: http
          host: "bitmagnet.{{ haondt__default_host }}"
      gluetun:
        protonvpn:
          server_countries: [Switzerland, Netherlands, Spain]
        wireguard.private_key: "{{ gluetun__wireguard__private_key }}"
        dns.upstream_resolvers: [cloudflare,quad9,google]
        firewall:
          input_ports: [http,bt1,bt2]
          outbound_subnets: [192.168.1.0/24]
      dependencies:
        - name: db
          port: http
      host_aliases:
        bitmagnet-db: &db-ip 192.168.1.211
    volumes:
      config:
        src.host:
          dir: "/mnt/pepper/gabbro_cluster/bitmagnet/config"
          read_only: false
          create: true
        dest.dir: /root/.config/bitmagnet
    command:
      - bitmagnet
      - worker
      - run
      - --keys=http_server
      - --keys=queue_server
      - --keys=dht_crawler
    environment:
      - raw:
          POSTGRES_HOST: bitmagnet-db
          POSTGRES_PASSWORD: postgres

  db:
    image: docker.io/library/postgres:16-alpine@sha256:0780ef0827baebe99b75a7feb7d97110d6ec1e4df3e5c4ec5b9a5143ef90ac3a
    talos: ^!
    resources:
      limits.memory: 1Gi
    networking:
      ports:
        http: 5432
      ip_addresses:
        - ip: *db-ip
          ports: [http]
          network_policy.create: false
    volumes:
      db-data:
        src.host:
          dir: /mnt/pepper/gabbro_cluster/bitmagnet/db
          read_only: false
          create: true
        dest.dir: /var/lib/postgresql/data
      db-dshm:
        src.tmpfs.size: 1Gi
        dest.dir: /dev/shm
    environment:
      - raw: 
          POSTGRES_DB: bitmagnet
          POSTGRES_PASSWORD: postgres
          PGUSER: postgres
