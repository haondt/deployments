components:
  primary:
    image: lscr.io/linuxserver/qbittorrent:latest@sha256:065792d2b11f0facff340210fc1cf13623b029a94ecdf08b02d06d922205f618
    talos: +!
    resources:
      limits.memory: 2Gi
    networking:
      ports:
        http: 8080
      gateway.http_routes:
        - port: http
          host: "qbittorrent.{{ haondt__default_host }}"
      gluetun:
        protonvpn:
          server_countries: [Switzerland, Netherlands, Spain]
        wireguard.private_key: "{{ gluetun__wireguard__private_key }}"
        port_forwarding:
          up_command: |-
            {{ gluetun__port_forwarding__up_command }}
          down_command: |-
            {{ gluetun__port_forwarding__down_command }}
        dns.upstream_resolvers: [cloudflare,quad9,google]
        firewall.input_ports: [http]
    volumes:
      config:
        src.host:
          dir: "/mnt/pepper/gabbro_cluster/qbittorrent/config"
          read_only: false
          create: true
        dest.dir: /config
      downloads:
        src.host:
          dir: "{{ media__host_dirs__downloads }}"
          read_only: false
        dest.dir: /downloads
      downloading:
        src.host:
          dir: "/mnt/carrot/gabbro/qbittorrent/incomplete"
          read_only: false
        dest.dir: /downloading
    startup:
      tasks:
        - chown:
            paths: [/config,/downloads,/downloading]
            owner: "{{ media__puid }}:{{ media__pgid }}"
        - busybox:
            script: |-
              set -euo pipefail
              set -x

              CONF_FILE="/config/qBittorrent/qBittorrent.conf"
              SECTION="\\[Preferences\\]"
              KEY="WebUI\\\\HostHeaderValidation"
              VALUE="false"

              mkdir -p "$(dirname "$CONF_FILE")"
              if [ ! -f "$CONF_FILE" ]; then
                  touch "$CONF_FILE"
                  chown {{ media__puid }}:{{ media__pgid }} "$CONF_FILE"
              fi

              if grep -q "^$KEY=" "$CONF_FILE"; then
                  sed -i "s/^$KEY=.*/$KEY=$VALUE/" "$CONF_FILE"
              else
                  sed -i "/^$SECTION/a $KEY=$VALUE" "$CONF_FILE"
              fi

              KEY="WebUI\\\\LocalHostAuth"
              VALUE="false"

              if grep -q "^$KEY=" "$CONF_FILE"; then
                  sed -i "s/^$KEY=.*/$KEY=$VALUE/" "$CONF_FILE"
              else
                  sed -i "/^$SECTION/a $KEY=$VALUE" "$CONF_FILE"
              fi
    environment:
      - raw:
          PGID: "{{ media__pgid }}"
          PUID: "{{ media__puid }}"
          WEBUI_PORT: 8080
          DOCKER_MODS: linuxserver/mods:universal-stdout-logs
          LOGS_TO_STDOUT: /config/qBittorrent/logs/qbittorrent.log

