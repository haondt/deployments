components:
  primary:
    image: lscr.io/linuxserver/qbittorrent:latest@sha256:098d4340c0709a9ddbc7010ca21900238388454e20182d52b9723b40a2a44293
    talos: +!
    resources:
      limits.memory: 2Gi
    networking:
      ports:
        http: 8080
        qb1: 3577
        qb2:
          port: 3577
          protocol: UDP
      ingresses:
        - port: http
          host: "qbittorrent.{{ haondt__default_host }}"
          tls.host: "*.{{ haondt__default_host }}"
      ip_addresses:
        - ip: 192.168.1.213
          ports: [qb1,qb2]
    volumes:
      config:
        src.host:
          dir: "/mnt/pepper/gabbro_cluster/qbittorrent/config"
          read_only: false
          create: true
        dest.dir: /config
      downloads:
        src.host:
          dir: "{{ media__host_dirs__downloads }}"
          read_only: false
        dest.dir: /downloads
      downloading:
        src.host:
          dir: "/mnt/celery/gabbro/qbittorrent/incomplete"
          read_only: false
        dest.dir: /downloading
    startup:
      tasks:
        - chown:
            paths: [/config,/downloads,/downloading]
            owner: "{{ media__puid }}:{{ media__pgid }}"
        - busybox:
            script: |-
              set -euo pipefail

              CONF_FILE="/config/qBittorrent/qBittorrent.conf"
              SECTION="\\[Preferences\\]"
              KEY="WebUI\\\\HostHeaderValidation"
              VALUE="false"

              if grep -q "^$KEY=" "$CONF_FILE"; then
                  sed -i "s/^$KEY=.*/$KEY=$VALUE/" "$CONF_FILE"
              else
                  sed -i "/^$SECTION/a $KEY=$VALUE" "$CONF_FILE"
              fi
    environment:
      - raw:
          PGID: "{{ media__pgid }}"
          PUID: "{{ media__puid }}"
          WEBUI_PORT: 8080
          DOCKER_MODS: linuxserver/mods:universal-stdout-logs
          LOGS_TO_STDOUT: /config/qBittorrent/logs/qbittorrent.log

