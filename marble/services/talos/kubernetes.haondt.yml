components:
  primary:
    image: registry.gitlab.com/haondt/cicd/registry/talos:0.1.2
    talos: x
    resources:
      limits.memory: 1Gi
    networking:
      ports:
        http: 8080
      rathole_routes:
        - port: http
          host: "api.{{ haondt__default_public_host }}"
          virtual_path: /talos/
          virtual_dest: /
      dependencies:
        - name: redis
          port: http
    volumes:
      id-rsa:
        src.file: id_rsa
        dest.file: /config/id_rsa
      git-repositories:
        src.tmpfs.size: 64Mi
        dest.dir: /var/talos/git
    startup:
      tasks:
        - chmod:
            paths: [/var/talos/git]
            mode: '0777'
    environment:
      - file: talos.env
        secret: true
    observability:
      alloy.logs.process: |
        stage.output {
            source = "json"
        }

        stage.json {
            expressions = {
                timestamp = "\"@t\"",
                dev_haondt_message_template = "\"@mt\"",
                message = "\"@m\"",
                trace_id = "\"@tr\"",
                level = "\"@l\"",
                exception = "\"@x\"",
                span_id = "\"@sp\"",
                source_context = "SourceContext",
            }
        }

        stage.template {
            source = "level"
            template = "{{ or .Value \"Info\" }}"
        }

        stage.timestamp {
            source = "timestamp"
            format = "RFC3339Nano"
        }

        stage.structured_metadata {
            values = {
                "message" = "",
                "trace_id" = "",
                "span_id" = "",
                "exception" = "",
                "source_context" = "",
            }
        }

        stage.labels {
            values = {
                "level" = "",
                "dev_haondt_message_template" = "",
            }
        }
      probes.hc:
        http_get:
          port: http
          path: /hc
        alloy.blackbox: {}
  redis:
    image: docker.io/library/redis:latest@sha256:47200b04138293fae39737e50878a238b13ec0781083126b1b0c63cf5d992e8d
    talos: +!
    networking:
      ports:
        http: 6379
    volumes:
      redis-data:
        src.pvc: {}
        dest.dir: /data
    startup:
      tasks:
        - chmod:
            paths: [/data]
            mode: '0777'
  redis-insight:
    image: docker.io/redis/redisinsight:latest@sha256:b2034915b9eeb0cea5a52e8ed06b22761ce2438e93762d66f5320506d56bfc8c
    talos: +!
    networking:
      ports:
        http: 5540
      ingresses:
        - port: http
          host: "talos-redis.{{ haondt__default_host }}"
          tls.host: "*.{{ haondt__default_host }}"
      dependencies:
        - name: redis
          port: http
    volumes:
      redis-insight-data:
        src.pvc.size: 64Mi
        dest.dir: /data
    startup:
      tasks:
        - chmod:
            paths: [/data]
            mode: '0777'
