components:
  primary:
    image: ghcr.io/plankanban/planka:latest@sha256:e469d724985db3f560ef0aa2218d54536212459bf8ecbdbc9fd995fc3cbe29db
    talos: +!
    networking:
      ports:
        http: 1337
      dependencies:
        - name: db
          port: http
      ingresses:
        - port: http
          host: "planka.{{ haondt__default_host }}"
    volumes:
      user-avatars:
        src.pvc.size: 128Mi
        dest.dir: /app/public/user-avatars
      background-images:
        src.pvc.size: 128Mi
        dest.dir: /app/public/project-background-images
      attachments:
        src.pvc.size: 128Mi
        dest.dir: /app/private/attachments
    environment:
      - raw: 
          BASE_URL: "https://planka.{{ haondt__default_host }}"
          DATABASE_URL: postgresql://postgres@planka-db:5432/planka
          SECRET_KEY: "{{ planka__secret_key }}"
          DEFAULT_ADMIN_EMAIL: planka@example.com # Do not remove if you want to prevent this user from being edited/deleted
          DEFAULT_ADMIN_PASSWORD: planka
          DEFAULT_ADMIN_NAME: "Planka Admin"
          DEFAULT_ADMIN_USERNAME: "planka"
          SHOW_DETAILED_AUTH_ERRORS: true
  db:
    image: docker.io/library/postgres:16-alpine@sha256:23e88eb049fd5d54894d70100df61d38a49ed97909263f79d4ff4c30a5d5fca2
    talos: ^!
    networking:
      ports:
        http: 5432
    volumes:
      db-data:
        src.pvc.size: 128Mi
        dest.dir: /var/lib/postgresql/data
    environment:
      - raw: 
          POSTGRES_DB: planka
          POSTGRES_HOST_AUTH_METHOD: trust
    charon:
      overlays: [daily]
      backups:
        - overlays: [default-gcs]
          repository_configs: &charon_repository_configs
            - raw: |-
                backend:
                  path: planka-db
          source.volumes: &charon_source
            db-data: [/]
        - overlays: [default-hzsb]
          repository_configs: *charon_repository_configs
          source.volumes: *charon_source

