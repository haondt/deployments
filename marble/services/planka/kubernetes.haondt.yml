components:
  primary:
    image: ghcr.io/plankanban/planka:latest@sha256:f82726333b953bd0d11184fa95a4fe4b068bab0e43e49254cf2963ad91b7c21a
    talos: +!
    networking:
      ports:
        http: 1337
      dependencies:
        - name: db
          port: http
      gateway.http_routes:
        - port: http
          host: "planka.{{ haondt__default_host }}"
    volumes:
      user-avatars:
        src.pvc.size: 128Mi
        dest.dir: /app/public/user-avatars
      background-images:
        src.pvc.size: 128Mi
        dest.dir: /app/public/project-background-images
      attachments:
        src.pvc.size: 128Mi
        dest.dir: /app/private/attachments
    environment:
      - raw: 
          BASE_URL: "https://planka.{{ haondt__default_host }}"
          DATABASE_URL: postgresql://postgres@planka-db:5432/planka
          SECRET_KEY: "{{ planka__secret_key }}"
          DEFAULT_ADMIN_EMAIL: planka@example.com # Do not remove if you want to prevent this user from being edited/deleted
          DEFAULT_ADMIN_PASSWORD: planka
          DEFAULT_ADMIN_NAME: "Planka Admin"
          DEFAULT_ADMIN_USERNAME: "planka"
          SHOW_DETAILED_AUTH_ERRORS: true
  db:
    image: docker.io/library/postgres:16-alpine@sha256:0780ef0827baebe99b75a7feb7d97110d6ec1e4df3e5c4ec5b9a5143ef90ac3a
    talos: ^!
    networking:
      ports:
        http: 5432
    volumes:
      db-data:
        src.pvc.size: 128Mi
        dest.dir: /var/lib/postgresql/data
    environment:
      - raw: 
          POSTGRES_DB: planka
          POSTGRES_HOST_AUTH_METHOD: trust
    charon:
      overlays: [daily]
      backups:
        - overlays: [default-gcs]
          repository_configs: &charon_repository_configs
            - raw: |-
                backend:
                  path: planka-db
          source.volumes: &charon_source
            db-data: [/]
        - overlays: [default-hzsb]
          repository_configs: *charon_repository_configs
          source.volumes: *charon_source

