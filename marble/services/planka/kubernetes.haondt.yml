components:
  primary:
    image: ghcr.io/plankanban/planka:latest@sha256:e469d724985db3f560ef0aa2218d54536212459bf8ecbdbc9fd995fc3cbe29db
    talos: +!
    networking:
      ports:
        http: 1337
      dependencies:
        - name: db
          port: http
      ingresses:
        - port: http
          host: "planka.{{ haondt__default_host }}"
    volumes:
      user-avatars:
        src.pvc.size: 128Mi
        dest.dir: /app/public/user-avatars
      background-images:
        src.pvc.size: 128Mi
        dest.dir: /app/public/project-background-images
      attachments:
        src.pvc.size: 128Mi
        dest.dir: /app/private/attachments
    environment:
      - raw: 
          BASE_URL: "https://planka.{{ haondt__default_host }}"
          DATABASE_URL: postgresql://postgres@planka-db-http:8080/planka
          SECRET_KEY: "{{ planka__secret_key }}"
          DEFAULT_ADMIN_EMAIL: planka@example.com # Do not remove if you want to prevent this user from being edited/deleted
          DEFAULT_ADMIN_PASSWORD: planka
          DEFAULT_ADMIN_NAME: "Planka Admin"
          DEFAULT_ADMIN_USERNAME: "planka"
          SHOW_DETAILED_AUTH_ERRORS: true
  db:
    image: docker.io/library/postgres:16-alpine@sha256:9d4951e6dc70422022512ff05ac86e0ae360da051c563accbed85d6f654c3357
    talos: ^!
    networking:
      ports:
        http: 5432
    volumes:
      db-data:
        src.pvc.size: 128Mi
        dest.dir: /var/lib/postgresql/data
    environment:
      - raw: 
          POSTGRES_DB: planka
          POSTGRES_HOST_AUTH_METHOD: trust
    charon:
      - overlays: [default-gcs, daily]
        repository_configs: &charon_repository_configs
          - raw: |-
              backend:
                path: planka-db
        source.volumes: &charon_source
          db-data: [/var/lib/postgresql/data]
      - overlays: [default-hzsb, daily]
        repository_configs: *charon_repository_configs
        source.volumes: *charon_source

