components:
  primary:
    image: registry.gitlab.com/haondt/cicd/registry/midas:fix-datetime-again-db4d00fb
    talos: x
    networking:
      ports:
        http: 8080
      gateway.http_routes:
        - port: http
          host: "midas.{{ haondt__default_host }}"
      dependencies:
        - name: node-red
          port: http
    resources.limits.memory: 1Gi
    volumes:
      data:
        src.pvc: {}
        dest.dir: /data
    startup:
      tasks:
        - chgrp:
            paths: [/data]
            group: 1000
        - chmod:
            paths: [/data]
            mode: '775'
    security.groups.add: [1000]
    environment:
      - raw:
          NodeRedSettings__ClientUrl: https://midas-node-red.{{ haondt__default_host }}
      - file: midas.env
        secret: false
    charon:
      overlays: [weekly]
      backups:
        - overlays: [default-gcs]
          repository_configs: &charon_repository_configs
            - raw: |-
                backend:
                  path: midas
          source.volumes: &charon_source
            data: [/]
        - overlays: [default-hzsb]
          repository_configs: *charon_repository_configs
          source.volumes: *charon_source
  node-red:
    image: registry.gitlab.com/haondt/cicd/registry/jobs:0.0.1
    talos: x
    networking:
      ports:
        http: 1880
      gateway.http_routes:
        - port: http
          host: "midas-node-red.{{ haondt__default_host }}"
      dependencies:
        - name: primary
          port: http
    volumes:
      node-red-settings:
        src.file: settings.js
        dest.file: /data/settings.js
      node-red-data:
        src.pvc.size: 16Mi
        dest.dir: /data
    startup:
      tasks:
        - chown:
            paths: [/data]
            owner: 1000:1000
    environment:
      - raw:
          MIDAS_API_URL: http://midas-primary:8080/
    charon:
      overlays: [weekly]
      backups:
        - overlays: [default-gcs]
          repository_configs: &charon_node_red_repository_configs
            - raw: |-
                unlock: true
                backend:
                  path: midas-node-red
          source.volumes: &charon_node_red_source
            node-red-data: [/]
        - overlays: [default-hzsb]
          repository_configs: *charon_node_red_repository_configs
          source.volumes: *charon_node_red_source
