components:
  primary:
    image: haumea/linktiles:0.0.6
    talos: x
    networking:
      ports:
        http: 5001
      rathole_routes:
        - port: http
          host: "linktiles.{{ haondt__default_cloud_host }}"
      dependencies:
        - name: redis
          port: http
    environment:
      - raw:
          LT_DB_ENGINE: redis
          LT_DB_HOST: linktiles-redis-http
          LT_DB_PORT: 8080
          LT_SECRET_KEY: "{{ linktiles__secret_key }}"
          LT_ENABLE_AUTH_PROXY: "true"
          LT_AUTH_PROXY_USERNAME_HEADER: "HTTP_REMOTE_USER"
          LT_AUTH_PROXY_LOGOUT_URL: https://auth.haondt.dev/logout

  redis:
    image: docker.io/library/redis:latest@sha256:4521b581dbddea6e7d81f8fe95ede93f5648aaa66a9dacd581611bf6fe7527bd
    talos: +!
    networking:
      ports:
        http: 6379
    volumes:
      redis-data:
        src.pvc.size: 64Mi
        dest.dir: /data
    startup.tasks:
        - chmod:
            paths: [/data]
            mode: '0777'
