# metadata:
#   namespace: glance # defaults to folder name
#   name: glance # defaults to folder name
spec:
  components:
    primary: # name primary automatically adds "primary" as the component label
      # metadata:
      #   labels:
      #     ...
        # annotations:
      #     ...
          
      spec:
        image: docker.io/glanceapp/glance:v0.8.4@sha256:6df86a7e8868d1eda21f35205134b1962c422957e42a0c44d4717c8e8f741b1a
        x-tl: +!
        # resources:
        #   requests:
        #     cpu: 10m
        #     memory: 16Mi
        #   limits:
        #     cpu: 100m
        #     memory: 64Mi
        # startup:
        #   # Dependency coordination
        #   waitFor:
        #     - database # shorthand, same format as network mounts
        #     - service: redis
        #       timeout: 60s
        #     - url: http://jackett:9117/health
        #       timeout: 30s
        #
        #   # Pre-startup tasks
        #   initTasks:
        #     - name: migrate-db
        #       image: migrate/migrate
        #       command: ['migrate', '-path', '/migrations', 'up']
        #     - name: warm-cache
        #       command: ['curl', 'http://localhost:8080/warmup']
        #
        #   # Startup ordering
        #   priority: 3  # Higher = starts later
        #
        # health:
        #   startup:
        #     httpGet:
        #       path: /health/startup
        #       port: 8080
        #     initialDelaySeconds: 10
        #     periodSeconds: 5
        #     failureThreshold: 30
        #
        #   readiness:
        #     httpGet:
        #       path: /health/ready
        #       port: 8080
        #     periodSeconds: 10
        #
        #   liveness:
        #     httpGet:
        #       path: /health/live
        #       port: 8080
        #     periodSeconds: 30
        #     timeoutSeconds: 5

        
        networking:
          ingress:
            enabled: true
            port: 8080
            host: "glance.{{ haondt__default_host }}"
            tls:
              enabled: true
              host: "*.{{ haondt__default_host }}"
          dependencies:
          # - foo/bar/baz # namespace=foo, app.haondt.dev/name=bar, app.haondt.dev/component=baz
          # - bar/baz # namespace=same namespace as this component, app.haondt.dev/name=bar, app.haondt.dev/component=baz
          # - baz # namespace=same namespace as this component, app.haondt.dev/name=same app as this components app, app.haondt.dev/component=baz
            - restic
            - github-graph
        volumes:
          config:
            path: /app/config
            configMap:
              source:
                glob: config/** # will be globbed and each file turned into a configmap
          assets:
            path: /app/config
            configMap:
              source:
                glob: assets/**
    restic:
      metadata:
        component: glance-extension # shorthand for labels:  app.kubernetes.io/component: glance-extension
      spec:
        image: ghcr.io/not-first/restic-glance-extension:latest@sha256:94b64d2cad519595cc4490a5c52ae312892c00464d6d47af0835d02e1facf372
        x-tl: x # talos funcitonality
        volumes:
          credentials:
            path: /app/config/credentials.json
            secret: # contents will be uploaded as secrets instead of configmaps
              source:
                path: credentials.json
          environment:
            env: true
            secret:
              source:
                path: glance-restic.env
    github-graph:
      metadata:
        component: glance-extension
      spec:
        image: haumea/glance-github-graph:0.0.2
        x-tl: x
        volumes:
          environment:
            env: true
            configMap:
              source: |
                CACHE_TYPE=memory
                CACHE_ENABLED=true

