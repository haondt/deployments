# metadata:
#   namespace: glance # defaults to folder name
#   name: glance # defaults to folder name
spec:
  components:
    primary: # name primary automatically adds "primary" as the component label
      # metadata:
      #   labels:
      #     ...
        # annotations:
      #     ...
          
      spec:
        image: docker.io/glanceapp/glance:v0.8.4@sha256:6df86a7e8868d1eda21f35205134b1962c422957e42a0c44d4717c8e8f741b1a
        x-tl: +!
        # resources:
        #   requests:
        #     cpu: 10m
        #     memory: 16Mi
        #   limits:
        #     cpu: 100m
        #     memory: 64Mi
        # startup:
        #   # Dependency coordination
        #   waitFor:
        #     - database # shorthand, same format as network mounts
        #     - service: redis
        #       timeout: 60s
        #     - url: http://jackett:9117/health
        #       timeout: 30s
        #
        #   # Pre-startup tasks
        #   initTasks:
        #     - name: migrate-db
        #       image: migrate/migrate
        #       command: ['migrate', '-path', '/migrations', 'up']
        #     - name: warm-cache
        #       command: ['curl', 'http://localhost:8080/warmup']
        #
        #   # Startup ordering
        #   priority: 3  # Higher = starts later
        #
        # health:
        #   startup:
        #     httpGet:
        #       path: /health/startup
        #       port: 8080
        #     initialDelaySeconds: 10
        #     periodSeconds: 5
        #     failureThreshold: 30
        #
        #   readiness:
        #     httpGet:
        #       path: /health/ready
        #       port: 8080
        #     periodSeconds: 10
        #
        #   liveness:
        #     httpGet:
        #       path: /health/live
        #       port: 8080
        #     periodSeconds: 30
        #     timeoutSeconds: 5

        
        networking:
          ports:
            http: 8080
          ingresses:
            - port: http
              host: "glance.{{ haondt__default_host }}"
              tls:
                # enabled: true # enabled by default
                host: "*.{{ haondt__default_host }}"
          dependencies:
          # - foo/bar/baz # namespace=foo, app.haondt.dev/name=bar, app.haondt.dev/component=baz
          # - bar/baz # namespace=same namespace as this component, app.haondt.dev/name=bar, app.haondt.dev/component=baz
          # - baz # namespace=same namespace as this component, app.haondt.dev/name=same app as this components app, app.haondt.dev/component=baz
            - name: restic
              port: 8675
            - name: github-graph
              port: http
        volumes:
          - src.dir: config
            dest.dir: /app/config
          - src.dir: assets
            dest.dir: /app/assets
    restic:
      metadata:
        component: glance-extension # shorthand for labels:  app.kubernetes.io/component: glance-extension
      spec:
        image: ghcr.io/not-first/restic-glance-extension:latest@sha256:94b64d2cad519595cc4490a5c52ae312892c00464d6d47af0835d02e1facf372
        networking:
          ports:
            http: 8675
        x-tl: x # talos funcitonality
        environment:
          - file: glance-restic.env
            secret: True
        volumes:
          - src.file: credentials.json
            src.secret: true
            dest.file: /app/config/credentials.json
    github-graph:
      metadata:
        component: glance-extension
      spec:
        image: haumea/glance-github-graph:0.0.2
        networking:
          ports:
            http: 8080
        x-tl: x
        environment:
          - raw: 
              CACHE_ENABLED: true
              CACHE_TYPE: memory
