components:
  primary:
    image: &linkding_image docker.io/sissbruecker/linkding:latest@sha256:e4fbafee44388d8555e34ffdc507224302989265009fc82f5f2762b789f0385a
    talos: +!
    networking:
      ports:
        http: 9090
      rathole_routes:
        - port: http
          host: "linkding.{{ haondt__default_cloud_host }}"
    volumes:
      data:
        src.pvc.size: 1Gi
        dest.dir: /etc/linkding/data

    startup:
      tasks:
        - chmod:
            paths: [/etc/linkding/data]
            mode: '777'
        - custom:
            image: *linkding_image
            command: [sh, -c]
            args: |-
              if [ ! -f /etc/linkding/data/.initialized ]; then
                python manage.py createsuperuser --noinput --username="{{ superuser__name }}" --email="{{ superuser__email }}" \
                && touch /etc/linkding/data/.initialized;
              fi
    environment:
      - file: linkding.env

